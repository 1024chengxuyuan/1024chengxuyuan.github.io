<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Synchronized锁的膨胀过程（锁的升级过程）深入剖析（三） | Hexo</title>
  <meta name="description" content="警告⚠️：本文耗时很长，先做好心理准备…………….哈哈哈 本篇我们讲通过大量实例代码及hotspot源码分析偏向锁(批量重偏向、批量撤销)、轻量级锁、重量级锁及锁的膨胀过程（也就是锁的升级过程） 我们先来说一下我们为什么需要锁？因为在并发情况为了保证线程的安全性，是在一个多线程环境下正确性的概念，也就是保证多线程环境下共享的、可修改的状态的正确性（这里的状态指的是程序里的数据），在java程序中我">
<meta property="og:type" content="article">
<meta property="og:title" content="Synchronized锁的膨胀过程（锁的升级过程）深入剖析（三）">
<meta property="og:url" content="https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="警告⚠️：本文耗时很长，先做好心理准备…………….哈哈哈 本篇我们讲通过大量实例代码及hotspot源码分析偏向锁(批量重偏向、批量撤销)、轻量级锁、重量级锁及锁的膨胀过程（也就是锁的升级过程） 我们先来说一下我们为什么需要锁？因为在并发情况为了保证线程的安全性，是在一个多线程环境下正确性的概念，也就是保证多线程环境下共享的、可修改的状态的正确性（这里的状态指的是程序里的数据），在java程序中我">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/06/28/SynchronizedLock2/1.png">
<meta property="article:published_time" content="2020-06-28T04:00:33.000Z">
<meta property="article:modified_time" content="2022-01-07T06:21:34.000Z">
<meta property="article:author" content="野生程序猿">
<meta property="article:tag" content="JMM內存模型">
<meta property="article:tag" content="Java并发编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/06/28/SynchronizedLock2/1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://1024chengxuyuan.github.io" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">野生程序猿</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Java Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/1024chengxuyuan" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%85%A7%E5%AD%98%E6%A8%A1%E5%9E%8B/">Java內存模型</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jvm/">Jvm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MicroService/">MicroService</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloudAlibaba/">SpringCloudAlibaba</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/elasticsearch/">elasticsearch</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/">编程技巧</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/">项目管理工具</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eureka/" rel="tag">Eureka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Feign/" rel="tag">Feign</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gateway/" rel="tag">Gateway</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JMM%E5%85%A7%E5%AD%98%E6%A8%A1%E5%9E%8B/" rel="tag">JMM內存模型</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%9F%BA%E7%A1%80/" rel="tag">Java基础</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">Java并发编程</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">Java性能优化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E6%A1%86%E6%9E%B6/" rel="tag">Java框架</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">Java虚拟机</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jvm%E6%A8%A1%E5%9E%8B/" rel="tag">Jvm模型</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MicroService/" rel="tag">MicroService</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nacos/" rel="tag">Nacos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ribbon/" rel="tag">Ribbon</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Seata/" rel="tag">Seata</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentinel/" rel="tag">Sentinel</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" rel="tag">排序算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" rel="tag">项目管理工具</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Docker/" style="font-size: 13px;">Docker</a> <a href="/tags/Eureka/" style="font-size: 13px;">Eureka</a> <a href="/tags/Feign/" style="font-size: 13px;">Feign</a> <a href="/tags/Gateway/" style="font-size: 13px;">Gateway</a> <a href="/tags/JMM%E5%85%A7%E5%AD%98%E6%A8%A1%E5%9E%8B/" style="font-size: 13.86px;">JMM內存模型</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 13.29px;">Java基础</a> <a href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 13.71px;">Java并发编程</a> <a href="/tags/Java%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 13px;">Java性能优化</a> <a href="/tags/Java%E6%A1%86%E6%9E%B6/" style="font-size: 13px;">Java框架</a> <a href="/tags/Java%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 13.14px;">Java虚拟机</a> <a href="/tags/Jvm%E6%A8%A1%E5%9E%8B/" style="font-size: 13.14px;">Jvm模型</a> <a href="/tags/Kafka/" style="font-size: 13.57px;">Kafka</a> <a href="/tags/MicroService/" style="font-size: 13px;">MicroService</a> <a href="/tags/Nacos/" style="font-size: 13.14px;">Nacos</a> <a href="/tags/Netty/" style="font-size: 13.43px;">Netty</a> <a href="/tags/RabbitMQ/" style="font-size: 14px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 13.43px;">Redis</a> <a href="/tags/Ribbon/" style="font-size: 13px;">Ribbon</a> <a href="/tags/RocketMQ/" style="font-size: 13.57px;">RocketMQ</a> <a href="/tags/Seata/" style="font-size: 13px;">Seata</a> <a href="/tags/Sentinel/" style="font-size: 13.14px;">Sentinel</a> <a href="/tags/SpringBoot/" style="font-size: 13px;">SpringBoot</a> <a href="/tags/elasticsearch/" style="font-size: 13.43px;">elasticsearch</a> <a href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" style="font-size: 13px;">排序算法</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.43px;">数据结构</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 13.57px;">消息队列</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 13px;">缓存</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 13px;">项目管理工具</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">30</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">15</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/01/18/null/" class="title">Redis原理篇</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-18T06:11:51.000Z" itemprop="datePublished">2023-01-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/01/18/null/" class="title">Redis高级篇-最佳实践</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-18T06:11:16.000Z" itemprop="datePublished">2023-01-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/01/18/null/" class="title">Redis高级篇-分布式缓存</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-18T06:11:06.000Z" itemprop="datePublished">2023-01-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/01/18/null/" class="title">Redis高级篇-多级缓存</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-18T06:10:57.000Z" itemprop="datePublished">2023-01-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/01/18/null/" class="title">Redis实战篇</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-18T06:09:09.000Z" itemprop="datePublished">2023-01-18</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-Synchronized锁的膨胀过程（锁的升级过程）深入剖析（三）" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Synchronized锁的膨胀过程（锁的升级过程）深入剖析（三）
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/06/28/SynchronizedLock2/" class="article-date">
	  <time datetime="2020-06-28T04:00:33.000Z" itemprop="datePublished">2020-06-28</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/JMM%E5%85%A7%E5%AD%98%E6%A8%A1%E5%9E%8B/" rel="tag">JMM內存模型</a>, <a class="article-tag-link-link" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">Java并发编程</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/06/28/SynchronizedLock2/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p><strong>警告⚠️：本文耗时很长，先做好心理准备…………….哈哈哈</strong></p>
<p>本篇我们讲通过大量实例代码及hotspot源码分析偏向锁(批量重偏向、批量撤销)、轻量级锁、重量级锁及锁的膨胀过程（也就是锁的升级过程）</p>
<h3 id="我们先来说一下我们为什么需要锁？"><a href="#我们先来说一下我们为什么需要锁？" class="headerlink" title="我们先来说一下我们为什么需要锁？"></a>我们先来说一下我们为什么需要锁？</h3><p>因为在并发情况为了保证线程的安全性，是在一个多线程环境下正确性的概念，也就是保证多线程环境下共享的、可修改的状态的正确性（这里的状态指的是程序里的数据），在java程序中我们可以使用synchronized关键字来对程序进行加锁。</p>
<p>当声明synchronized代码块的时候，编译成的字节码将包含monitorenter指令 和 monitorexit指令。这两种指令均会消耗操作数栈上的一个引用类型的元素（也就是 synchronized 关键字括号里的引用），作为所要加锁解锁的锁对象。</p>
<p>（注意：jdk 1.6以前synchronized 关键字只表示重量级锁，1.6之后区分为偏向锁、轻量级锁、重量级锁。）</p>
<p>所谓锁的升级、降级，就是 JVM 优化 synchronized 运行的机制，当 JVM 检测到不同的竞争状况时，会自动切换到适合的锁实现，这种切换就是锁的升级、降级：</p>
<ul>
<li>当没有竞争出现时，默认会使用偏向锁。JVM 会利用 CAS 操作（compare and swap），在对象头上的 Mark Word 部分设置线程 ID，以表示这个对象偏向于当前线程，所以并不涉及真正的互斥锁。这样做的假设是基于在很多应用场景中，大部分对象生命周期中最多会被一个线程锁定，使用偏向锁可以降低无竞争开销。</li>
<li>如果有另外的线程试图锁定某个已经被偏向过的对象，JVM 就需要撤销（revoke）偏向锁，并切换到轻量级锁实现。轻量级锁依赖 CAS 操作 Mark Word 来试图获取锁，如果重试成功，就使用轻量级锁；否则，进一步升级为重量级锁</li>
</ul>
<p>那么我们来看段synchronized代码分析：</p>
<p>java代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample1 &#123;</span><br><span class="line">    static TestDemo testDemo;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        testDemo= new TestDemo();</span><br><span class="line">        synchronized (testDemo)&#123;</span><br><span class="line">            System.out.println(&quot;lock ing&quot;);</span><br><span class="line">            testDemo.hashCode();</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行并分析TestDemo.class文件命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c DemoExample1.class</span><br></pre></td></tr></table></figure>

<p>分析结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Compiled from &quot;DemoExample1.java&quot;</span><br><span class="line">public class com.boke.DemoExample1 &#123;</span><br><span class="line">  static com.boke.TestDemo testDemo;</span><br><span class="line"> </span><br><span class="line">  public com.boke.DemoExample1();</span><br><span class="line">    Code:</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       4: return</span><br><span class="line"> </span><br><span class="line">  public static void main(java.lang.String[]) throws java.lang.Exception;</span><br><span class="line">    Code:</span><br><span class="line">       0: new           #2                  // class com/boke/TestDemo</span><br><span class="line">       3: dup</span><br><span class="line">       4: invokespecial #3                  // Method com/boke/TestDemo.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       7: putstatic     #4                  // Field testDemo:Lcom/boke/TestDemo;</span><br><span class="line">      10: getstatic     #4                  // Field testDemo:Lcom/boke/TestDemo;</span><br><span class="line">      13: dup</span><br><span class="line">      14: astore_1</span><br><span class="line">      15: monitorenter</span><br><span class="line">      16: getstatic     #5                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      19: ldc           #6                  // String lock ing</span><br><span class="line">      21: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">      24: getstatic     #4                  // Field testDemo:Lcom/boke/TestDemo;</span><br><span class="line">      27: invokevirtual #8                  // Method java/lang/Object.hashCode:()I</span><br><span class="line">      30: pop</span><br><span class="line">      31: getstatic     #5                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      34: getstatic     #4                  // Field testDemo:Lcom/boke/TestDemo;</span><br><span class="line">      37: invokestatic  #9                  // Method org/openjdk/jol/info/ClassLayout.parseInstance:(Ljava/lang/Object;)Lorg/openjdk/jol/info/ClassLayout;</span><br><span class="line">      40: invokevirtual #10                 // Method org/openjdk/jol/info/ClassLayout.toPrintable:()Ljava/lang/String;</span><br><span class="line">      43: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">      46: aload_1</span><br><span class="line">      47: monitorexit</span><br><span class="line">      48: goto          56</span><br><span class="line">      51: astore_2</span><br><span class="line">      52: aload_1</span><br><span class="line">      53: monitorexit</span><br><span class="line">      54: aload_2</span><br><span class="line">      55: athrow</span><br><span class="line">      56: return</span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">          16    48    51   any</span><br><span class="line">          51    54    51   any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过字节码可以看出包含一个monitorenter指令以及多个monitorexit指令。这是因为jvm需要确保所获得的锁在正常执行路径，以及异常执行路径上都能够被解锁。</p>
<p><strong>我们可以抽象的理解为每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针</strong>：</p>
<ul>
<li><p>当执行 monitorenter 时，如果目标锁对象的计数器为 0，那么说明它没有被其他线程所持有。在这个情况下，Java 虚拟机会将该锁对象的持有线程设置为当前线程，并且将其计数器加 1。</p>
</li>
<li><p>在目标锁对象的计数器不为 0 的情况下，如果锁对象的持有线程是当前线程，那么 Java 虚拟机可以将其计数器加 1，否则需要等待，直至持有线程释放该锁。当执行 monitorexit 时，Java 虚拟机则需将锁对象的计数器减 1。当计数器减为 0 时，那便代表该锁已经被释放掉了。</p>
</li>
<li><p>之所以采用这种计数器的方式，是为了允许同一个线程重复获取同一把锁。举个例子，如果一个 Java 类中拥有多个 synchronized 方法，那么这些方法之间的相互调用，不管是直接的还是间接的，都会涉及对同一把锁的重复加锁操作。因此，我们需要设计这么一个可重入的特性，来避免编程里的隐式约束。</p>
</li>
</ul>
<p>我们来看一个案例：在<strong>不加锁</strong>的情况多下通过取两次数值然后进行对比，来模拟两次共享状态的操作:</p>
<p>java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoExample3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> sharedState;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">nonSafeAction</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (sharedState &lt; <span class="number">100000</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">former</span> <span class="operator">=</span> sharedState++;</span><br><span class="line">            <span class="type">int</span> <span class="variable">latter</span> <span class="operator">=</span> sharedState;</span><br><span class="line">            <span class="keyword">if</span> (former != latter - <span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Observed data race, former is &quot;</span> +</span><br><span class="line">                        former + <span class="string">&quot;, &quot;</span> + <span class="string">&quot;latter is &quot;</span> + latter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">DemoExample3</span> <span class="variable">demoExample3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DemoExample3</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                demoExample3.nonSafeAction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">   </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                demoExample3.nonSafeAction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在没有加 synchronized 关键字的时候打印出来的结果（截取部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observed data race, former is 55179, latter is 55181</span><br><span class="line">Observed data race, former is 56752, latter is 56754</span><br><span class="line">Observed data race, former is 58304, latter is 58306</span><br><span class="line">Observed data race, former is 60340, latter is 60342</span><br><span class="line">Observed data race, former is 61627, latter is 61629</span><br><span class="line">Observed data race, former is 63107, latter is 62946</span><br><span class="line">Observed data race, former is 64029, latter is 64029</span><br><span class="line">Observed data race, former is 65579, latter is 65581</span><br><span class="line">Observed data race, former is 67315, latter is 67317</span><br><span class="line">Observed data race, former is 68542, latter is 68542</span><br><span class="line">Observed data race, former is 70687, latter is 70687</span><br><span class="line">Observed data race, former is 72654, latter is 72656</span><br><span class="line">Observed data race, former is 74644, latter is 74646</span><br></pre></td></tr></table></figure>

<p>就会发现，打印出好多与<strong>if (former !&#x3D; latter - 1) 条件相符的值，</strong>这是错误的，正确的结果应该是一条也没有；</p>
<p>我们在来看一下加上synchronized关键字的代码：</p>
<p>java代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class DemoExample3 &#123;</span><br><span class="line">    public int sharedState;</span><br><span class="line">   </span><br><span class="line">    public void nonSafeAction() &#123;</span><br><span class="line">        while (sharedState &lt; 100000) &#123;</span><br><span class="line">            synchronized (this) &#123;</span><br><span class="line">                int former = sharedState++;</span><br><span class="line">                int latter = sharedState;</span><br><span class="line">                if (former != latter - 1) &#123;</span><br><span class="line">                    System.out.println(&quot;Observed data race, former is &quot; +</span><br><span class="line">                            former + &quot;, &quot; + &quot;latter is &quot; + latter);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        final DemoExample3 demoExample3 = new DemoExample3();</span><br><span class="line">        Thread thread1 = new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                demoExample3.nonSafeAction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">   </span><br><span class="line">        Thread thread2 = new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                demoExample3.nonSafeAction();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这次看下加上synchronized关键字的打印出来的结果：</p>
<p>这次看下加上synchronized关键字的打印出来的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>说明将两次赋值过程用synchronized保护起来，使用this作为互斥单元，就可以避免别的线程并发的去修改sharedState；这也就是我刚开说的并发情况下为了保证线程的安全性，我们可以通过加锁来保证。</p>
<h3 id="说完我们为什么需要锁，接下来我们介绍偏向锁、轻量级锁、重量级锁及锁的膨胀过程："><a href="#说完我们为什么需要锁，接下来我们介绍偏向锁、轻量级锁、重量级锁及锁的膨胀过程：" class="headerlink" title="说完我们为什么需要锁，接下来我们介绍偏向锁、轻量级锁、重量级锁及锁的膨胀过程："></a>说完我们为什么需要锁，接下来我们<strong>介绍偏向锁、轻量级锁、重量级锁及锁的膨胀过程</strong>：</h3><p>首先我们先从jvm源码中来分析锁的膨胀过程（锁升级的过程）：</p>
<p>在jvm中synchronized的是行为是jvm runntime的一部分，所以我们需要先找到 Runtime 相关的功能实现。通过在代码中查询类似“monitor_enter”或“Monitor Enter”，很直观的就可以定位到：</p>
<p>sharedRuntime.cpp（<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk/file/6659a8f57d78/src/hotspot/share/runtime/sharedRuntime.cpp%EF%BC%89%EF%BC%8C%E5%AE%83%E6%98%AF%E8%A7%A3%E9%87%8A%E5%99%A8%E5%92%8C%E7%BC%96%E8%AF%91%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E5%9F%BA%E7%B1%BB%EF%BC%9A">http://hg.openjdk.java.net/jdk/jdk/file/6659a8f57d78/src/hotspot/share/runtime/sharedRuntime.cpp），它是解释器和编译器运行时的基类：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// Handles the uncommon case in locking, i.e., contention or an inflated lock.</span><br><span class="line">JRT_BLOCK_ENTRY(void, SharedRuntime::complete_monitor_locking_C(oopDesc* _obj, BasicLock* lock, JavaThread* thread))</span><br><span class="line">  // Disable ObjectSynchronizer::quick_enter() in default config</span><br><span class="line">  // on AARCH64 and ARM until JDK-8153107 is resolved.</span><br><span class="line">  if (ARM_ONLY((SyncFlags &amp; 256) != 0 &amp;&amp;)</span><br><span class="line">      AARCH64_ONLY((SyncFlags &amp; 256) != 0 &amp;&amp;)</span><br><span class="line">      !SafepointSynchronize::is_synchronizing()) &#123;</span><br><span class="line">    // Only try quick_enter() if we&#x27;re not trying to reach a safepoint</span><br><span class="line">    // so that the calling thread reaches the safepoint more quickly.</span><br><span class="line">    if (ObjectSynchronizer::quick_enter(_obj, thread, lock)) return;</span><br><span class="line">  &#125;</span><br><span class="line">  // NO_ASYNC required because an async exception on the state transition destructor</span><br><span class="line">  // would leave you with the lock held and it would never be released.</span><br><span class="line">  // The normal monitorenter NullPointerException is thrown without acquiring a lock</span><br><span class="line">  // and the model is that an exception implies the method failed.</span><br><span class="line">  JRT_BLOCK_NO_ASYNC</span><br><span class="line">  oop obj(_obj);</span><br><span class="line">  if (PrintBiasedLockingStatistics) &#123;</span><br><span class="line">    Atomic::inc(BiasedLocking::slow_path_entry_count_addr());</span><br><span class="line">  &#125;</span><br><span class="line">  Handle h_obj(THREAD, obj);</span><br><span class="line">  //在 JVM 启动时，我们可以指定是否开启偏向锁</span><br><span class="line">  if (UseBiasedLocking) &#123;</span><br><span class="line">  // Retry fast entry if bias is revoked to avoid unnecessary inflation</span><br><span class="line"> &lt;strong&gt; //fast_enter 是我们熟悉的完整锁获取路径&lt;/strong&gt;</span><br><span class="line">    ObjectSynchronizer::fast_enter(h_obj, lock, true, CHECK);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">  //slow_enter 则是绕过偏向锁，直接进入轻量级锁获取逻辑</span><br><span class="line">    ObjectSynchronizer::slow_enter(h_obj, lock, CHECK);</span><br><span class="line">  &#125;</span><br><span class="line">  assert(!HAS_PENDING_EXCEPTION, &quot;Should have no exception here&quot;);</span><br><span class="line">  JRT_BLOCK_END</span><br><span class="line">JRT_END</span><br></pre></td></tr></table></figure>

<p>synchronizer.cpp（<a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk/jdk/file/896e80158d35/src/hotspot/share/runtime/synchronizer.cpp%EF%BC%89%EF%BC%8CJVM">https://hg.openjdk.java.net/jdk/jdk/file/896e80158d35/src/hotspot/share/runtime/synchronizer.cpp），JVM</a> 同步相关的各种基础（不仅仅是 synchronized 的逻辑，包括从本地代码，也就是 JNI，触发的 Monitor 动作，全都可以在里面找到例如（jni_enter&#x2F;jni_exit））：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line">// -----------------------------------------------------------------------------</span><br><span class="line">//  Fast Monitor Enter/Exit</span><br><span class="line">// This the fast monitor enter. The interpreter and compiler use</span><br><span class="line">// some assembly copies of this code. Make sure update those code</span><br><span class="line">// if the following function is changed. The implementation is</span><br><span class="line">// extremely sensitive to race condition. Be careful.</span><br><span class="line">void ObjectSynchronizer::fast_enter(Handle obj, BasicLock* lock,</span><br><span class="line">                                    bool attempt_rebias, TRAPS) &#123;</span><br><span class="line">  if (UseBiasedLocking) &#123;</span><br><span class="line">    if (!SafepointSynchronize::is_at_safepoint()) &#123;</span><br><span class="line">      //biasedLocking定义了偏向锁相关操作，revoke_and_rebias revokeatsafepoint 则定义了当检测到安全点时的处理</span><br><span class="line">      BiasedLocking::Condition cond = BiasedLocking::revoke_and_rebias(obj, attempt_rebias, THREAD);</span><br><span class="line">      if (cond == BiasedLocking::BIAS_REVOKED_AND_REBIASED) &#123;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      assert(!attempt_rebias, &quot;can not rebias toward VM thread&quot;);</span><br><span class="line">      BiasedLocking::revoke_at_safepoint(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  //如果获取偏向锁失败，则进入 slow_enter，锁升级</span><br><span class="line">  slow_enter(obj, lock, THREAD);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">// -----------------------------------------------------------------------------</span><br><span class="line">// Interpreter/Compiler Slow Case</span><br><span class="line">// This routine is used to handle interpreter/compiler slow case</span><br><span class="line">// We don&#x27;t need to use fast path here, because it must have been</span><br><span class="line">// failed in the interpreter/compiler code.</span><br><span class="line">void ObjectSynchronizer::slow_enter(Handle obj, BasicLock* lock, TRAPS) &#123;</span><br><span class="line">  markOop mark = obj-&gt;mark();</span><br><span class="line">  assert(!mark-&gt;has_bias_pattern(), &quot;should not see bias pattern here&quot;);</span><br><span class="line">  if (mark-&gt;is_neutral()) &#123;</span><br><span class="line">    // Anticipate successful CAS -- the ST of the displaced mark must</span><br><span class="line">    // be visible &lt;= the ST performed by the CAS.</span><br><span class="line">    // 将目前的 Mark Word 复制到 Displaced Header 上</span><br><span class="line">    lock-&gt;set_displaced_header(mark);</span><br><span class="line">    // 利用 CAS 设置对象的 Mark Wo</span><br><span class="line">    if (mark == obj()-&gt;cas_set_mark((markOop) lock, mark)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    // Fall through to inflate() …</span><br><span class="line">    // 检查存在竞争</span><br><span class="line">  &#125; else if (mark-&gt;has_locker() &amp;&amp;</span><br><span class="line">             THREAD-&gt;is_lock_owned((address)mark-&gt;locker())) &#123;</span><br><span class="line">    assert(lock != mark-&gt;locker(), &quot;must not re-lock the same lock&quot;);</span><br><span class="line">    assert(lock != (BasicLock*)obj-&gt;mark(), &quot;don&#x27;t relock with same BasicLock”);</span><br><span class="line">    // 清除</span><br><span class="line">    lock-&gt;set_displaced_header(NULL);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  // The object header will never be displaced to this lock,</span><br><span class="line">  // so it does not matter what the value is, except that it</span><br><span class="line">  // must be non-zero to avoid looking like a re-entrant lock,</span><br><span class="line">  // and must not look locked either.</span><br><span class="line">  // 重置 Displaced Header</span><br><span class="line">  lock-&gt;set_displaced_header(markOopDesc::unused_mark());</span><br><span class="line">  //锁膨胀</span><br><span class="line">  ObjectSynchronizer::inflate(THREAD,</span><br><span class="line">                              obj(),</span><br><span class="line">                              inflate_cause_monitor_enter)-&gt;enter(THREAD);</span><br><span class="line">&#125;</span><br><span class="line">// This routine is used to handle interpreter/compiler slow case</span><br><span class="line">// We don&#x27;t need to use fast path here, because it must have</span><br><span class="line">// failed in the interpreter/compiler code. Simply use the heavy</span><br><span class="line">// weight monitor should be ok, unless someone find otherwise.</span><br><span class="line">void ObjectSynchronizer::slow_exit(oop object, BasicLock* lock, TRAPS) &#123;</span><br><span class="line">  fast_exit(object, lock, THREAD);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">//锁膨胀</span><br><span class="line">ObjectMonitor * ATTR ObjectSynchronizer::inflate (Thread * Self, oop object) &#123;</span><br><span class="line">  // Inflate mutates the heap ...</span><br><span class="line">  // Relaxing assertion for bug 6320749.</span><br><span class="line">  assert (Universe::verify_in_progress() ||</span><br><span class="line">          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;) ;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  for (;;) &#123;//自旋</span><br><span class="line">      const markOop mark = object-&gt;mark() ;</span><br><span class="line">      assert (!mark-&gt;has_bias_pattern(), &quot;invariant&quot;) ;</span><br><span class="line">  </span><br><span class="line">      // The mark can be in one of the following states:</span><br><span class="line">      // *  Inflated     - just return</span><br><span class="line">      // *  Stack-locked - coerce it to inflated</span><br><span class="line">      // *  INFLATING    - busy wait for conversion to complete</span><br><span class="line">      // *  Neutral      - aggressively inflate the object.</span><br><span class="line">      // *  BIASED       - Illegal.  We should never see this</span><br><span class="line">   </span><br><span class="line">      // CASE: inflated已膨胀，即重量级锁</span><br><span class="line">      if (mark-&gt;has_monitor()) &#123;//判断当前是否为重量级锁</span><br><span class="line">          ObjectMonitor * inf = mark-&gt;monitor() ;//获取指向ObjectMonitor的指针</span><br><span class="line">          assert (inf-&gt;header()-&gt;is_neutral(), &quot;invariant&quot;);</span><br><span class="line">          assert (inf-&gt;object() == object, &quot;invariant&quot;) ;</span><br><span class="line">          assert (ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);</span><br><span class="line">          return inf ;</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      // CASE: inflation in progress - inflating over a stack-lock.膨胀等待（其他线程正在从轻量级锁转为膨胀锁）</span><br><span class="line">      // Some other thread is converting from stack-locked to inflated.</span><br><span class="line">      // Only that thread can complete inflation -- other threads must wait.</span><br><span class="line">      // The INFLATING value is transient.</span><br><span class="line">      // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.</span><br><span class="line">      // We could always eliminate polling by parking the thread on some auxiliary list.</span><br><span class="line">      if (mark == markOopDesc::INFLATING()) &#123;</span><br><span class="line">         TEVENT (Inflate: spin while INFLATING) ;</span><br><span class="line">         ReadStableMark(object) ;</span><br><span class="line">         continue ;</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      // CASE: stack-locked栈锁（轻量级锁）</span><br><span class="line">      // Could be stack-locked either by this thread or by some other thread.</span><br><span class="line">      //</span><br><span class="line">      // Note that we allocate the objectmonitor speculatively, _before_ attempting</span><br><span class="line">      // to install INFLATING into the mark word.  We originally installed INFLATING,</span><br><span class="line">      // allocated the objectmonitor, and then finally STed the address of the</span><br><span class="line">      // objectmonitor into the mark.  This was correct, but artificially lengthened</span><br><span class="line">      // the interval in which INFLATED appeared in the mark, thus increasing</span><br><span class="line">      // the odds of inflation contention.</span><br><span class="line">      //</span><br><span class="line">      // We now use per-thread private objectmonitor free lists.</span><br><span class="line">      // These list are reprovisioned from the global free list outside the</span><br><span class="line">      // critical INFLATING...ST interval.  A thread can transfer</span><br><span class="line">      // multiple objectmonitors en-mass from the global free list to its local free list.</span><br><span class="line">      // This reduces coherency traffic and lock contention on the global free list.</span><br><span class="line">      // Using such local free lists, it doesn&#x27;t matter if the omAlloc() call appears</span><br><span class="line">      // before or after the CAS(INFLATING) operation.</span><br><span class="line">      // See the comments in omAlloc().</span><br><span class="line">  </span><br><span class="line">      if (mark-&gt;has_locker()) &#123;</span><br><span class="line">          ObjectMonitor * m = omAlloc (Self) ;//获取一个可用的ObjectMonitor</span><br><span class="line">          // Optimistically prepare the objectmonitor - anticipate successful CAS</span><br><span class="line">          // We do this before the CAS in order to minimize the length of time</span><br><span class="line">          // in which INFLATING appears in the mark.</span><br><span class="line">          m-&gt;Recycle();</span><br><span class="line">          m-&gt;_Responsible  = NULL ;</span><br><span class="line">          m-&gt;OwnerIsThread = 0 ;</span><br><span class="line">          m-&gt;_recursions   = 0 ;</span><br><span class="line">          m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit ;   // Consider: maintain by type/class</span><br><span class="line">   </span><br><span class="line">          markOop cmp = (markOop) Atomic::cmpxchg_ptr (markOopDesc::INFLATING(), object-&gt;mark_addr(), mark) ;</span><br><span class="line">          if (cmp != mark) &#123;//CAS失败//CAS失败，说明冲突了，自旋等待//CAS失败，说明冲突了，自旋等待//CAS失败，说明冲突了，自旋等待</span><br><span class="line">             omRelease (Self, m, true) ;//释放监视器锁</span><br><span class="line">             continue ;       // Interference -- just retry</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          // We&#x27;ve successfully installed INFLATING (0) into the mark-word.</span><br><span class="line">          // This is the only case where 0 will appear in a mark-work.</span><br><span class="line">          // Only the singular thread that successfully swings the mark-word</span><br><span class="line">          // to 0 can perform (or more precisely, complete) inflation.</span><br><span class="line">          //</span><br><span class="line">          // Why do we CAS a 0 into the mark-word instead of just CASing the</span><br><span class="line">          // mark-word from the stack-locked value directly to the new inflated state?</span><br><span class="line">          // Consider what happens when a thread unlocks a stack-locked object.</span><br><span class="line">          // It attempts to use CAS to swing the displaced header value from the</span><br><span class="line">          // on-stack basiclock back into the object header.  Recall also that the</span><br><span class="line">          // header value (hashcode, etc) can reside in (a) the object header, or</span><br><span class="line">          // (b) a displaced header associated with the stack-lock, or (c) a displaced</span><br><span class="line">          // header in an objectMonitor.  The inflate() routine must copy the header</span><br><span class="line">          // value from the basiclock on the owner&#x27;s stack to the objectMonitor, all</span><br><span class="line">          // the while preserving the hashCode stability invariants.  If the owner</span><br><span class="line">          // decides to release the lock while the value is 0, the unlock will fail</span><br><span class="line">          // and control will eventually pass from slow_exit() to inflate.  The owner</span><br><span class="line">          // will then spin, waiting for the 0 value to disappear.   Put another way,</span><br><span class="line">          // the 0 causes the owner to stall if the owner happens to try to</span><br><span class="line">          // drop the lock (restoring the header from the basiclock to the object)</span><br><span class="line">          // while inflation is in-progress.  This protocol avoids races that might</span><br><span class="line">          // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.</span><br><span class="line">          // Critically, while object-&gt;mark is 0 mark-&gt;displaced_mark_helper() is stable.</span><br><span class="line">          // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator</span><br><span class="line">          // fetch the displaced mark from the owner&#x27;s stack.</span><br><span class="line">          // The owner can&#x27;t die or unwind past the lock while our INFLATING</span><br><span class="line">          // object is in the mark.  Furthermore the owner can&#x27;t complete</span><br><span class="line">          // an unlock on the object, either.</span><br><span class="line">          markOop dmw = mark-&gt;displaced_mark_helper() ;</span><br><span class="line">          assert (dmw-&gt;is_neutral(), &quot;invariant&quot;) ;</span><br><span class="line">          //CAS成功，设置ObjectMonitor的_header、_owner和_object等</span><br><span class="line">          // Setup monitor fields to proper values -- prepare the monitor</span><br><span class="line">          m-&gt;set_header(dmw) ;</span><br><span class="line"> </span><br><span class="line">          // Optimization: if the mark-&gt;locker stack address is associated</span><br><span class="line">          // with this thread we could simply set m-&gt;_owner = Self and</span><br><span class="line">          // m-&gt;OwnerIsThread = 1. Note that a thread can inflate an object</span><br><span class="line">          // that it has stack-locked -- as might happen in wait() -- directly</span><br><span class="line">          // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.</span><br><span class="line">          m-&gt;set_owner(mark-&gt;locker());</span><br><span class="line">          m-&gt;set_object(object);</span><br><span class="line">          // TODO-FIXME: assert BasicLock-&gt;dhw != 0.</span><br><span class="line">  </span><br><span class="line">          // Must preserve store ordering. The monitor state must</span><br><span class="line">          // be stable at the time of publishing the monitor address.</span><br><span class="line">          guarantee (object-&gt;mark() == markOopDesc::INFLATING(), &quot;invariant&quot;) ;</span><br><span class="line">          object-&gt;release_set_mark(markOopDesc::encode(m));</span><br><span class="line">   </span><br><span class="line">          // Hopefully the performance counters are allocated on distinct cache lines</span><br><span class="line">          // to avoid false sharing on MP systems ...</span><br><span class="line">          if (ObjectMonitor::_sync_Inflations != NULL) ObjectMonitor::_sync_Inflations-&gt;inc() ;</span><br><span class="line">          TEVENT(Inflate: overwrite stacklock) ;</span><br><span class="line">          if (TraceMonitorInflation) &#123;</span><br><span class="line">            if (object-&gt;is_instance()) &#123;</span><br><span class="line">              ResourceMark rm;</span><br><span class="line">              tty-&gt;print_cr(&quot;Inflating object &quot; INTPTR_FORMAT &quot; , mark &quot; INTPTR_FORMAT &quot; , type %s&quot;,</span><br><span class="line">                (void *) object, (intptr_t) object-&gt;mark(),</span><br><span class="line">                object-&gt;klass()-&gt;external_name());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          return m ;</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      // CASE: neutral 无锁</span><br><span class="line">      // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.</span><br><span class="line">      // If we know we&#x27;re inflating for entry it&#x27;s better to inflate by swinging a</span><br><span class="line">      // pre-locked objectMonitor pointer into the object header.   A successful</span><br><span class="line">      // CAS inflates the object *and* confers ownership to the inflating thread.</span><br><span class="line">      // In the current implementation we use a 2-step mechanism where we CAS()</span><br><span class="line">      // to inflate and then CAS() again to try to swing _owner from NULL to Self.</span><br><span class="line">      // An inflateTry() method that we could call from fast_enter() and slow_enter()</span><br><span class="line">      // would be useful.</span><br><span class="line">  </span><br><span class="line">      assert (mark-&gt;is_neutral(), &quot;invariant&quot;);</span><br><span class="line">      ObjectMonitor * m = omAlloc (Self) ;</span><br><span class="line">      // prepare m for installation - set monitor to initial state</span><br><span class="line">      m-&gt;Recycle();</span><br><span class="line">      m-&gt;set_header(mark);</span><br><span class="line">      m-&gt;set_owner(NULL);</span><br><span class="line">      m-&gt;set_object(object);</span><br><span class="line">      m-&gt;OwnerIsThread = 1 ;</span><br><span class="line">      m-&gt;_recursions   = 0 ;</span><br><span class="line">      m-&gt;_Responsible  = NULL ;</span><br><span class="line">      m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit ;       // consider: keep metastats by type/class</span><br><span class="line">   </span><br><span class="line">      if (Atomic::cmpxchg_ptr (markOopDesc::encode(m), object-&gt;mark_addr(), mark) != mark) &#123;</span><br><span class="line">          m-&gt;set_object (NULL) ;</span><br><span class="line">          m-&gt;set_owner  (NULL) ;</span><br><span class="line">          m-&gt;OwnerIsThread = 0 ;</span><br><span class="line">          m-&gt;Recycle() ;</span><br><span class="line">          omRelease (Self, m, true) ;</span><br><span class="line">          m = NULL ;</span><br><span class="line">          continue ;</span><br><span class="line">          // interference - the markword changed - just retry.</span><br><span class="line">          // The state-transitions are one-way, so there&#x27;s no chance of</span><br><span class="line">          // live-lock -- &quot;Inflated&quot; is an absorbing state.</span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">      // Hopefully the performance counters are allocated on distinct</span><br><span class="line">      // cache lines to avoid false sharing on MP systems ...</span><br><span class="line">      if (ObjectMonitor::_sync_Inflations != NULL) ObjectMonitor::_sync_Inflations-&gt;inc() ;</span><br><span class="line">      TEVENT(Inflate: overwrite neutral) ;</span><br><span class="line">      if (TraceMonitorInflation) &#123;</span><br><span class="line">        if (object-&gt;is_instance()) &#123;</span><br><span class="line">          ResourceMark rm;</span><br><span class="line">          tty-&gt;print_cr(&quot;Inflating object &quot; INTPTR_FORMAT &quot; , mark &quot; INTPTR_FORMAT &quot; , type %s&quot;,</span><br><span class="line">            (void *) object, (intptr_t) object-&gt;mark(),</span><br><span class="line">            object-&gt;klass()-&gt;external_name());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return m ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>膨胀过程的实现比较复杂，大概实现过程如下：</strong></p>
<p>1、整个膨胀过程在自旋下完成；</p>
<p>2、mark-&gt;has_monitor()方法判断当前是否为重量级锁，即Mark Word的锁标识位为 10，如果当前状态为重量级锁，执行步骤（3），否则执行步骤（4）；</p>
<p>3、mark-&gt;monitor()方法获取指向ObjectMonitor的指针，并返回，说明膨胀过程已经完成；</p>
<p>4、如果当前锁处于膨胀中，说明该锁正在被其它线程执行膨胀操作，则当前线程就进行自旋等待锁膨胀完成，这里需要注意一点，虽然是自旋操作，但不会一直占用cpu资源，每隔一段时间会通过os::NakedYield方法放弃cpu资源，或通过park方法挂起；如果其他线程完成锁的膨胀操作，则退出自旋并返回；</p>
<p>5、如果当前是轻量级锁状态，即锁标识位为 00，膨胀过程如下：</p>
<ul>
<li>通过omAlloc方法，获取一个可用的ObjectMonitor monitor，并重置monitor数据；</li>
<li>通过CAS尝试将Mark Word设置为markOopDesc:INFLATING，标识当前锁正在膨胀中，如果CAS失败，说明同一时刻其它线程已经将Mark Word设置为markOopDesc:INFLATING，当前线程进行自旋等待膨胀完成；</li>
<li>如果CAS成功，设置monitor的各个字段：_header、_owner和_object等，并返回；</li>
</ul>
<p>6、如果是无锁，重置监视器值；</p>
<p>以上就是从jvm源码来分析锁的膨胀过程了。</p>
<h3 id="接下来我们案例入手开始分析偏向锁（批量重偏向、批量撤销）、轻量级锁、重量级锁及膨胀过程："><a href="#接下来我们案例入手开始分析偏向锁（批量重偏向、批量撤销）、轻量级锁、重量级锁及膨胀过程：" class="headerlink" title="接下来我们案例入手开始分析偏向锁（批量重偏向、批量撤销）、轻量级锁、重量级锁及膨胀过程："></a><strong>接下来我们案例入手开始分析偏向锁（批量重偏向、批量撤销）、轻量级锁、重量级锁及膨胀过程：</strong></h3><h4 id="偏向锁："><a href="#偏向锁：" class="headerlink" title="偏向锁："></a><strong>偏向锁：</strong></h4><ul>
<li>偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁，降低获取锁的代价。</li>
<li>在大多数情况下，锁总是由同一线程多次获得，不存在多线程竞争，所以出现了偏向锁。其目标就是在只有一个线程执行同步代码块时能够提高性能。</li>
<li>当一个线程访问同步代码块并获取锁时，会在Mark Word里存储锁偏向的线程ID。在线程进入和退出同步块时不再通过CAS操作来加锁和解锁，而是检测Mark Word里是否存储着指向当前线程的偏向锁。引入偏向锁是为了在无多线程竞争的情况下尽量减少不必要的轻量级锁执行路径，因为轻量级锁的获取及释放依赖多次CAS原子指令，而偏向锁只需要在置换ThreadID的时候依赖一次CAS原子指令即可。</li>
<li>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程不会主动释放偏向锁。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断锁对象是否处于被锁定状态。撤销偏向锁后恢复到无锁（标志位为“01”）或轻量级锁（标志位为“00”）的状态。</li>
<li>偏向锁在JDK 6及以后的JVM里是默认启用的。可以通过JVM参数关闭偏向锁：-XX:-UseBiasedLocking&#x3D;false，关闭之后程序默认会进入轻量级锁状态。</li>
</ul>
<p>在上篇【<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yuhangwang/p/11267364.html">java并发笔记三之synchronized 偏向锁 轻量级锁 重量级锁证明</a>】说过偏向锁在没有禁止延迟的时候还没加锁之前就已经是偏向锁了，但是加锁完之后，退出同步代码块 还是偏向锁；计算过hashcode之后就不能被偏向。</p>
<p>一、我们来看段代码证明下，在没有计算hashcode的情况下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//创建一个啥都没有的类：</span><br><span class="line">public class TestDemo &#123;&#125;</span><br><span class="line">  </span><br><span class="line">public class DemoExample &#123;</span><br><span class="line">    static TestDemo testDemo;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        //此处睡眠50000ms，取消jvm默认偏向锁延迟4000ms</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        testDemo= new TestDemo();</span><br><span class="line">  </span><br><span class="line">        //hash计算？</span><br><span class="line">        //testDemo.hashCode();</span><br><span class="line">  </span><br><span class="line">        System.out.println(&quot;befor lock&quot;);</span><br><span class="line">        //无锁：偏向锁？</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">  </span><br><span class="line">        synchronized (testDemo)&#123;</span><br><span class="line">            System.out.println(&quot;lock ing&quot;);</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        System.out.println(&quot;after lock&quot;);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">befor lock</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">lock ing</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 80 80 ac (00000101 10000000 10000000 10101100) (-1400864763)</span><br><span class="line">      4     4        (object header)                           8d 7f 00 00 (10001101 01111111 00000000 00000000) (32653)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">after lock</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 80 80 ac (00000101 10000000 10000000 10101100) (-1400864763)</span><br><span class="line">      4     4        (object header)                           8d 7f 00 00 (10001101 01111111 00000000 00000000) (32653)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>

<p>分析结果：</p>
<p>befor lock：绿颜色表示：虽然是偏向锁，但是黄颜色表示没有任何线程持有锁（一个对象被初始化的时候是可偏向的）</p>
<p>lock  ing： 绿颜色表示偏向锁，黄颜色的表示当前线程拿到锁</p>
<p>after lock：绿颜色表示偏向锁，黄颜色的表示当前线程拿到锁，还是偏向的状态；（偏向锁退出锁后依然是偏向状态）</p>
<p>jvm在初始化一个对象的时候，如果没有启用偏向锁延迟，就会去判断这个对象是否可以被偏向，如果可以就是偏向锁；退出同步代码块 还是偏向锁。</p>
<p>二、在对象进行hashcode计算之后就会输出下面的结果（也就是代码的这块**testDemo.hashCode()**去掉注释，进行hashcode运算）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">befor lock</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">lock ing</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           f8 28 4b 0c (11111000 00101000 01001011 00001100) (206252280)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">after lock</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 80 80 ac (00000101 10000000 10000000 10101100) (-1400864763)</span><br><span class="line">      4     4        (object header)                           8d 7f 00 00 (10001101 01111111 00000000 00000000) (32653)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>结果显示并不是偏向锁了，说明对象在计算过hashcode之后就不能被偏向；</p>
<ol>
<li>具体来说，在线程进行加锁时，如果该锁对象支持偏向锁，那么 Java 虚拟机会通过 CAS操作，将当前线程的地址记录在锁对象的标记字段之中，并且将标记字段的最后三位设置为：1 01；</li>
<li>在接下来的运行过程中，每当有线程请求这把锁，Java 虚拟机只需判断锁对象标记字段中：最后三位是否为： 1 01，是否包含当前线程的地址，以及 epoch 值是否和锁对象的类的epoch 值相同。如果都满足，那么当前线程持有该偏向锁，可以直接返回；</li>
</ol>
<h3 id="这里的-epoch-值是一个什么概念呢？"><a href="#这里的-epoch-值是一个什么概念呢？" class="headerlink" title="这里的 epoch 值是一个什么概念呢？"></a>这里的 <strong>epoch 值是一个什么概念呢？</strong></h3><ul>
<li>我们先从偏向锁的撤销讲起。当请求加锁的线程和锁对象标记字段保持的线程地址不匹配时（而且 epoch 值相等，如若不等，那么当前线程可以将该锁重偏向至自己），Java 虚拟机需要撤销该偏向锁。这个撤销过程非常麻烦，它要求持有偏向锁的线程到达安全点，再将偏向锁替换成轻量级锁；</li>
<li>如果某一类锁对象的总撤销数超过了一个阈值（对应 jvm参数 **-**<strong>XX:BiasedLockingBulkRebiasThreshold，默认为 20</strong>），那么 Java 虚拟机会宣布这个类的偏向锁失效；（这里说的就是批量重偏向）</li>
</ul>
<p>​    JVM源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">product(intx, BiasedLockingBulkRebiasThreshold, 20,                       \</span><br><span class="line">        &quot;Threshold of number of revocations per type to try to &quot;          \</span><br><span class="line">        &quot;rebias all objects in the heap of that type&quot;)                    \</span><br><span class="line">        range(0, max_intx)                                                \</span><br><span class="line">        constraint(BiasedLockingBulkRebiasThresholdFunc,AfterErgo)        \</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<ul>
<li>具体的做法便是在每个类中维护一个 epoch 值，你可以理解为第几代偏向锁。当设置偏向锁时，Java 虚拟机需要将该 epoch 值复制到锁对象的标记字段中；</li>
<li>在宣布某个类的偏向锁失效时，Java 虚拟机实则将该类的 epoch 值加 1，表示之前那一代的偏向锁已经失效。而新设置的偏向锁则需要复制新的 epoch 值；</li>
<li>为了保证当前持有偏向锁并且已加锁的线程不至于因此丢锁，Java 虚拟机需要遍历所有线程的 Java 栈，找出该类已加锁的实例，并且将它们标记字段中的 epoch 值加 1。该操作需要所有线程处于安全点状态；</li>
<li>如果总撤销数超过另一个阈值（对应 jvm 参数 **-**<strong>XX:BiasedLockingBulkRevokeThreshold，默认值为 40</strong>），那么 Java 虚拟机会认为这个类已经不再适合偏向锁。此时，Java 虚拟机会撤销该类实例的偏向锁，并且在之后的加锁过程中直接为该类实例设置轻量级锁(这里说的就是偏向批量撤销)</li>
</ul>
<p>​    </p>
<p>JVM源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">product(intx, BiasedLockingBulkRevokeThreshold, 40,                       \</span><br><span class="line">        &quot;Threshold of number of revocations per type to permanently &quot;     \</span><br><span class="line">        &quot;revoke biases of all objects in the heap of that type&quot;)          \</span><br><span class="line">        range(0, max_intx)                                                \</span><br><span class="line">        constraint(BiasedLockingBulkRevokeThresholdFunc,AfterErgo)  </span><br></pre></td></tr></table></figure>

<p>接下来我们分析两个批量重偏向相关案例（禁止偏向锁延迟的情况下：-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay&#x3D;0）：</p>
<p>案例一：</p>
<p>java代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample4 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">   public class DemoExample5 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    /**</span><br><span class="line">     * 仅证明批量重偏向</span><br><span class="line">     * @throws InterruptedException</span><br><span class="line">     */</span><br><span class="line">    public  static  void test1() throws InterruptedException &#123;</span><br><span class="line">        List&lt;TestDemo&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            list.add(new TestDemo());</span><br><span class="line">        &#125;</span><br><span class="line">        Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(&quot;加锁前 get(0) 应该是无锁可偏向 &quot;+ ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">            for (TestDemo a:list  ) &#123;</span><br><span class="line">                synchronized (a)&#123;</span><br><span class="line">                    System.out.print(&quot;加锁 &gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">            System.out.println(&quot;加锁后 get(0) 应该是偏向锁&quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">            try &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(1000);//这里不让线程死，防止线程ID复用</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(5);</span><br><span class="line">        Thread t2 = new Thread(()-&gt;&#123;</span><br><span class="line">            for (int i = 0; i &lt; 40; i++) &#123;</span><br><span class="line">                TestDemo a = list.get(i);</span><br><span class="line">                synchronized (a)&#123;</span><br><span class="line">                    System.out.print(&quot;加锁 &gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==18)&#123;</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(18) 应该是无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==19)&#123; //开始重偏向</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(19) 应该是偏向锁 &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                    System.out.println(&quot;加锁后 get(0) 应该是无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">                    System.out.println(&quot;加锁后 get(99) 应该是偏向锁 偏向t1 &quot;+ClassLayout.parseInstance(list.get(99)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==20)&#123;</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(20) 应该是偏向锁 &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行并分析结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;</span><br><span class="line"> </span><br><span class="line">加锁后 get(0) 应该是偏向锁com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 30 8a 73 (00000101 00110000 10001010 01110011) (1938436101)</span><br><span class="line">      4     4        (object header)                           c4 7f 00 00 (11000100 01111111 00000000 00000000) (32708)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;</span><br><span class="line">加锁后 get(18) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;</span><br><span class="line">加锁后 get(19) 应该是偏向锁 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 41 0b 75 (00000101 01000001 00001011 01110101) (1963671813)</span><br><span class="line">      4     4        (object header)                           c4 7f 00 00 (11000100 01111111 00000000 00000000) (32708)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁后 get(0) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁后 get(99) 应该是偏向锁 偏向t1 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 30 8a 73 (00000101 00110000 10001010 01110011) (1938436101)</span><br><span class="line">      4     4        (object header)                           c4 7f 00 00 (11000100 01111111 00000000 00000000) (32708)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;</span><br><span class="line">加锁后 get(20) 应该是偏向锁 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 41 0b 75 (00000101 01000001 00001011 01110101) (1963671813)</span><br><span class="line">      4     4        (object header)                           c4 7f 00 00 (11000100 01111111 00000000 00000000) (32708)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>案例二：</p>
<p>java代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample7 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">  </span><br><span class="line">        List&lt;TestDemo&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        //初始化数据</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            list.add(new TestDemo());</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        Thread t1 = new Thread() &#123;</span><br><span class="line">            String name = &quot;1&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (TestDemo a : list) &#123;</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t1 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        System.out.println(&quot;main 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(list.get(10)).toPrintable());</span><br><span class="line">   </span><br><span class="line">        Thread t2 = new Thread() &#123;</span><br><span class="line">            String name = &quot;2&quot;;</span><br><span class="line">  </span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                    TestDemo a = list.get(i);</span><br><span class="line">                    // hack 为了在批量重偏向发生后再次加锁,前面使用了轻量级锁的对象</span><br><span class="line">                    if (i == 20) &#123;</span><br><span class="line">                        a = list.get(9);</span><br><span class="line">                    &#125;</span><br><span class="line">   </span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (i == 10) &#123;</span><br><span class="line">                            //已经经过偏向锁撤销，并使用轻量级锁的对象，释放后  状态依为001 无锁状态</span><br><span class="line">                            System.out.println(&quot;t2 i=10 get(1)预期是无锁&quot; + ClassLayout.parseInstance(list.get(1)).toPrintable());</span><br><span class="line">                            //因为和t1交替使用对象a 没有发生竞争，但偏向锁已偏向，另外不满足重偏向条件，所以使用轻量级锁</span><br><span class="line">                            System.out.println(&quot;t2 i=10 get(i) 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (i == 19) &#123;</span><br><span class="line">                            //已经经过偏向锁撤销，并使用轻量级锁的对象，在批量重偏向发生后。不会影响现有的状态  状态依然为001</span><br><span class="line">                            System.out.println(&quot;t2  i=19  get(10)预期是无锁&quot; + 10 + ClassLayout.parseInstance(list.get(10)).toPrintable());</span><br><span class="line">                            //满足重偏向条件后，已偏向的对象可以重新使用偏向锁 将线程id指向当前线程，101</span><br><span class="line">                            System.out.println(&quot;t2  i=19  get(i) 满足重偏向条件20 预期偏向锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">                            //满足重偏向条件后，已偏向还为需要加锁的对象依然偏向线程1 因为偏向锁的撤销是发生在下次加锁的时候。这里没有执行到同步此对象，所以依然偏向t1</span><br><span class="line">                            System.out.println(&quot;t2  i=19  get(i) 满足重偏向条件20 但后面的对象没有被加锁，所以依旧偏向t1 &quot; + i + ClassLayout.parseInstance(list.get(40)).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (i == 20) &#123;</span><br><span class="line">                            //满足重偏向条件后，再次加锁之前使用了轻量级锁的对象，依然轻量级锁，证明重偏向这个状态只针对偏向锁。已经发生锁升级的，不会退回到偏向锁</span><br><span class="line">                            System.out.println(&quot;t2  i=20 满足偏向条件之后，之前被设置为无锁状态的对象，不可偏向，这里使用的是轻量级锁  get(9)预期是轻量级锁 &quot; + ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行并分析结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">t1 预期是偏向锁10  com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 78 86 af (00000101 01111000 10000110 10101111) (-1350141947)</span><br><span class="line">      4     4        (object header)                           f6 7f 00 00 (11110110 01111111 00000000 00000000) (32758)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">main 预期是偏向锁 10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 78 86 af (00000101 01111000 10000110 10101111) (-1350141947)</span><br><span class="line">      4     4        (object header)                           f6 7f 00 00 (11110110 01111111 00000000 00000000) (32758)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">2t2 i=10 get(1)预期是无锁 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2 i=10 get(i) 预期轻量级锁 10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 69 42 08 (00001000 01101001 01000010 00001000) (138569992)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=19  get(10)预期是无锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=19  get(i) 满足重偏向条件20 预期偏向锁 19com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 71 95 ae (00000101 01110001 10010101 10101110) (-1365937915)</span><br><span class="line">      4     4        (object header)                           f6 7f 00 00 (11110110 01111111 00000000 00000000) (32758)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=19  get(i) 满足重偏向条件20 但后面的对象没有被加锁，所以依旧偏向t1 19com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 78 86 af (00000101 01111000 10000110 10101111) (-1350141947)</span><br><span class="line">      4     4        (object header)                           f6 7f 00 00 (11110110 01111111 00000000 00000000) (32758)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=20 满足偏向条件之后，之前被设置为无锁状态的对象，不可偏向，这里使用的是轻量级锁  get(9)预期是轻量级锁 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 69 42 08 (00001000 01101001 01000010 00001000) (138569992)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           05 d6 00 f8 (00000101 11010110 00000000 11111000) (-134162939)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>

<p>接下来我们分析两个批量偏向撤销的相关案例（禁止偏向锁延迟的情况下：-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay&#x3D;0）：</p>
<p>案例一：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">public class DemoExample6 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        test2();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    /**</span><br><span class="line">     * 证明偏量偏向撤销</span><br><span class="line">     * @throws InterruptedException</span><br><span class="line">     */</span><br><span class="line">    public  static  void test2() throws InterruptedException &#123;</span><br><span class="line">        List&lt;TestDemo&gt; list = new ArrayList&lt;TestDemo&gt;();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            list.add(new TestDemo());</span><br><span class="line">        &#125;</span><br><span class="line">        Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(&quot;加锁前 get(0) 应该是无锁可偏向 &quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">            for (TestDemo a:list  ) &#123;</span><br><span class="line">                synchronized (a)&#123;</span><br><span class="line">                    System.out.print(&quot;加锁 &gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">            System.out.println(&quot;加锁后 get(0) 应该是偏向锁&quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">            try &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(1000);//这里不让线程死，防止线程ID复用</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(5);</span><br><span class="line">        Thread t2 = new Thread(()-&gt;&#123;</span><br><span class="line">            for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                TestDemo a = list.get(i);</span><br><span class="line">                synchronized (a)&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getId()+&quot;加锁 &gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(100);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==9)&#123;//这里刚好是第19个上锁的（同样是第19个偏向锁升级的）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(9) 应该是无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==10)&#123;//这里刚好是第21个上锁的</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(10) 应该是偏向锁 偏向t2 &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==50)&#123;//50开始升级为轻量级锁（同样是第21个偏向锁升级的）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(50) 无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==59)&#123;//60（同样是第39个偏向锁升级的）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(59) 无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==69)&#123;//69（同样是第59个偏向锁升级的）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(69) 无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(i)).toPrintable());</span><br><span class="line">                    TestDemo a1 = new TestDemo();</span><br><span class="line">                    synchronized (a1)&#123;</span><br><span class="line">                        System.out.println(&quot;偏向撤销发生后的该类新建的对象都不会再偏向任何线程 &quot;+ClassLayout.parseInstance(a1).toPrintable());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">   </span><br><span class="line">        Thread t3 = new Thread(()-&gt;&#123;</span><br><span class="line">            for (int i = 99; i &gt;= 0; i--) &#123;</span><br><span class="line">                TestDemo a = list.get(i);</span><br><span class="line">                synchronized (a)&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getId()+&quot;加锁 &gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(100);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                /**</span><br><span class="line">                 * 重点：重偏向撤销</span><br><span class="line">                 */</span><br><span class="line">                if (i==40)&#123;//40升级为轻量级锁（同样是第40个偏向锁升级的，这时候发生偏向撤销）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(&quot;+i+&quot;) 应该是无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">                    TestDemo a1 = new TestDemo();</span><br><span class="line">                    synchronized (a1)&#123;</span><br><span class="line">                        System.out.println(&quot;偏向撤销发生后的该类新建的对象都不会再偏向任何线程 &quot;+ClassLayout.parseInstance(a1).toPrintable());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (i==30)&#123;//39升级为轻量级锁（同样是第42个偏向锁升级的）</span><br><span class="line">                    System.out.println();</span><br><span class="line">                    System.out.println(&quot;加锁后 get(&quot;+i+&quot;) 应该是无锁（轻量级锁释放） &quot;+ClassLayout.parseInstance(list.get(0)).toPrintable());</span><br><span class="line">                    TestDemo a1 = new TestDemo();</span><br><span class="line">                    synchronized (a1)&#123;</span><br><span class="line">                        System.out.println(&quot;偏向撤销发生后的该类新建的对象都不会再偏向任何线程 &quot;+ClassLayout.parseInstance(a1).toPrintable());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t2.start();</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(50);</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;　　</span><br></pre></td></tr></table></figure>

<p>运行结果（截取部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">加锁前 get(0) 应该是无锁可偏向 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;加锁 &gt;</span><br><span class="line"> </span><br><span class="line">加锁后 get(0) 应该是偏向锁com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 e0 84 08 (00000101 11100000 10000100 00001000) (142925829)</span><br><span class="line">      4     4        (object header)                           b1 7f 00 00 (10110001 01111111 00000000 00000000) (32689)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">加锁后 get(9) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">15加锁 &gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁后 get(90) 应该是偏向锁 偏向t3com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 89 01 0c (00000101 10001001 00000001 00001100) (201427205)</span><br><span class="line">      4     4        (object header)                           b1 7f 00 00 (10110001 01111111 00000000 00000000) (32689)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">加锁后 get(10) 应该是偏向锁 偏向t2 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 b1 0a 08 (00000101 10110001 00001010 00001000) (134918405)</span><br><span class="line">      4     4        (object header)                           b1 7f 00 00 (10110001 01111111 00000000 00000000) (32689)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">15加锁 &gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">加锁后 get(89) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">加锁后 get(50) 无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">15加锁 &gt;</span><br><span class="line">  </span><br><span class="line">加锁后 get(49) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">加锁后 get(59) 无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line">  </span><br><span class="line">15加锁 &gt; </span><br><span class="line"> </span><br><span class="line">加锁后 get(40) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line">  </span><br><span class="line">偏向撤销发生后的该类新建的对象都不会再偏向任何线程 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           48 18 a6 09 (01001000 00011000 10100110 00001001) (161880136)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line">加锁后 get(69) 无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line">  </span><br><span class="line">偏向撤销发生后的该类新建的对象都不会再偏向任何线程 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           50 e8 95 09 (01010000 11101000 10010101 00001001) (160819280)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line">  </span><br><span class="line">15加锁 &gt;</span><br><span class="line"> </span><br><span class="line">加锁后 get(30) 应该是无锁（轻量级锁释放） com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line">  </span><br><span class="line">偏向撤销发生后的该类新建的对象都不会再偏向任何线程 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           48 18 a6 09 (01001000 00011000 10100110 00001001) (161880136)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           43 c1 00 f8 (01000011 11000001 00000000 11111000) (-134168253)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>

<p>案例二：</p>
<p>　</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample8 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        List&lt;TestDemo&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;TestDemo&gt; list2 = new ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;TestDemo&gt; list3 = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            list.add(new TestDemo());</span><br><span class="line">            list2.add(new TestDemo());</span><br><span class="line">            list3.add(new TestDemo());</span><br><span class="line">        &#125;</span><br><span class="line">        //偏向锁</span><br><span class="line">        System.out.println(&quot;初始状态&quot; + 10 + ClassLayout.parseClass(TestDemo.class).toPrintable());</span><br><span class="line">   </span><br><span class="line">        Thread t1 = new Thread() &#123;</span><br><span class="line">            String name = &quot;1&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (TestDemo a : list) &#123;</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list.get(10)) &#123;</span><br><span class="line">                            //偏向锁</span><br><span class="line">                            System.out.println(&quot;t1 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(a).toPrintable());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        //偏向锁</span><br><span class="line">        System.out.println(&quot;main 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(list.get(10)).toPrintable());</span><br><span class="line">        Thread t2 = new Thread() &#123;</span><br><span class="line">            String name = &quot;2&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                    TestDemo a = list.get(i);</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t2 i=10 get(1)预期是无锁&quot; + ClassLayout.parseInstance(list.get(1)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t2 i=10 get(10) 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (a == list.get(19)) &#123;</span><br><span class="line">                            System.out.println(&quot;t2  i=19  get(10)预期是无锁&quot; + 10 + ClassLayout.parseInstance(list.get(10)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t2  i=19  get(19) 满足重偏向条件20 预期偏向锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;类的对象累计撤销达到20&quot;);</span><br><span class="line">                        &#125; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t2.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">  </span><br><span class="line">        Thread t3 = new Thread() &#123;</span><br><span class="line">            String name = &quot;3&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (TestDemo a : list2) &#123;</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list2.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t3 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t3.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">  </span><br><span class="line">        Thread t4 = new Thread() &#123;</span><br><span class="line">            String name = &quot;4&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                    TestDemo a = list2.get(i);</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list2.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t4 i=10 get(1)预期是无锁&quot; + ClassLayout.parseInstance(list2.get(1)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t4 i=10 get(10) 当前不满足重偏向条件 20 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (a == list2.get(19)) &#123;</span><br><span class="line">                            System.out.println(&quot;t4  i=19  get(10)预期是无锁&quot; + 10 + ClassLayout.parseInstance(list2.get(10)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t4 i=19 get(19) 当前满足重偏向条件 20 但A类的对象累计撤销达到40 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;类的对象累计撤销达到40&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (a == list2.get(20)) &#123;</span><br><span class="line">                            System.out.println(&quot;t4 i=20 get(20) 当前满足重偏向条件 20 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t4.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        System.out.println(&quot;main 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(list3.get(0)).toPrintable());//偏向锁</span><br><span class="line">        Thread t5 = new Thread() &#123;</span><br><span class="line">            String name = &quot;5&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (TestDemo a : list3) &#123;</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list3.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t5 预期是轻量级锁，类的对象累计撤销达到40 不可以用偏向锁了&quot; + 10 + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t5.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        System.out.println(&quot;main 预期是偏向锁&quot; + 10 + ClassLayout.parseInstance(list.get(10)).toPrintable());//偏向锁</span><br><span class="line">  </span><br><span class="line">        Thread t6 = new Thread() &#123;</span><br><span class="line">            String name = &quot;6&quot;;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.printf(name);</span><br><span class="line">                for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                    TestDemo a = list3.get(i);</span><br><span class="line">                    synchronized (a) &#123;</span><br><span class="line">                        if (a == list3.get(10)) &#123;</span><br><span class="line">                            System.out.println(&quot;t6 i=10 get(1)预期是无锁&quot; + ClassLayout.parseInstance(list3.get(1)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t6 i=10 get(10) 预期轻量级锁 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (a == list3.get(19)) &#123;</span><br><span class="line">                            System.out.println(&quot;t6  i=19  get(10)预期是无锁&quot; + 10 + ClassLayout.parseInstance(list3.get(10)).toPrintable());//偏向锁</span><br><span class="line">                            System.out.println(&quot;t6  i=19  get(19) 满足重偏向条件20 但类的对象累计撤销达到40 不可以用偏向锁了 &quot; + i + ClassLayout.parseInstance(a).toPrintable());//偏向锁</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">  </span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        t6.start();</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">  </span><br><span class="line">        System.out.println(&quot;由于撤销锁次数达到默认的 BiasedLockingBulkRevokeThreshold=40 这里实例化的对象 是无锁状态&quot; + ClassLayout.parseInstance(new TestDemo()).toPrintable());//偏向锁</span><br><span class="line">　　　　 System.out.println(&quot;撤销偏向后状态&quot; + 10 + ClassLayout.parseInstance(new TestDemo()).toPrintable());//偏向锁</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">初始状态10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0    12        (object header)                           N/A</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">1t1 预期是偏向锁10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 e0 86 8e (00000101 11100000 10000110 10001110) (-1903763451)</span><br><span class="line">      4     4        (object header)                           ec 7f 00 00 (11101100 01111111 00000000 00000000) (32748)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">main 预期是偏向锁10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 e0 86 8e (00000101 11100000 10000110 10001110) (-1903763451)</span><br><span class="line">      4     4        (object header)                           ec 7f 00 00 (11101100 01111111 00000000 00000000) (32748)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">2t2 i=10 get(1)预期是无锁com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2 i=10 get(10) 预期轻量级锁 10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 99 7a 03 (00001000 10011001 01111010 00000011) (58366216)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=19  get(10)预期是无锁10 com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t2  i=19  get(19) 满足重偏向条件20 预期偏向锁 19com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 09 90 91 (00000101 00001001 10010000 10010001) (-1852831483)</span><br><span class="line">      4     4        (object header)                           ec 7f 00 00 (11101100 01111111 00000000 00000000) (32748)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">类的对象累计撤销达到20</span><br><span class="line">3t3 预期是偏向锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 09 89 90 (00000101 00001001 10001001 10010000) (-1870067451)</span><br><span class="line">      4     4        (object header)                           ec 7f 00 00 (11101100 01111111 00000000 00000000) (32748)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">4t4 i=10 get(1)预期是无锁com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t4 i=10 get(10) 当前不满足重偏向条件 20 预期轻量级锁 10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 f9 9a 03 (00001000 11111001 10011010 00000011) (60487944)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t4  i=19  get(10)预期是无锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t4 i=19 get(19) 当前满足重偏向条件 20 但A类的对象累计撤销达到40 预期轻量级锁 19com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 f9 9a 03 (00001000 11111001 10011010 00000011) (60487944)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">类的对象累计撤销达到40</span><br><span class="line">t4 i=20 get(20) 当前满足重偏向条件 20 预期轻量级锁 20com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 f9 9a 03 (00001000 11111001 10011010 00000011) (60487944)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">main 预期是偏向锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">5t5 预期是轻量级锁，A类的对象累计撤销达到40 不可以用偏向锁了10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 f9 9a 03 (00001000 11111001 10011010 00000011) (60487944)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">main 预期是偏向锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">6t6 i=10 get(1)预期是无锁com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t6 i=10 get(10) 预期轻量级锁 10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 29 ab 03 (00001000 00101001 10101011 00000011) (61548808)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t6  i=19  get(10)预期是无锁10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t6  i=19  get(19) 满足重偏向条件20 但A类的对象累计撤销达到40 不可以用偏向锁了 19com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           08 29 ab 03 (00001000 00101001 10101011 00000011) (61548808)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">由于类撤销锁次数达到默认的 BiasedLockingBulkRevokeThreshold=40 这里实例化的对象 是无锁状态com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">撤销偏向后状态10com.boke.TestDemo object internals:</span><br><span class="line">OFFSET SIZE TYPE DESCRIPTION　　　　　　　　　　　　　　　　　　　　 VALUE</span><br><span class="line">　　0 　　 4 　　　　　　 (object header) 　　　　　　　　　　　　　　 01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">　　4 　　 4　　　　　　　 (object header) 　　　　　　　　　　　　　　00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">　　8 　　 4 　　　　　　 (object header) 　　　　　　　　　　　　　　 bf c3 00 f8 (10111111 11000011 00000000 11111000) (-134167617)</span><br><span class="line">　　12　　 4 　　　　　　 (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure>

<p>以上案例证实了偏向锁的批量重偏向和批量撤销，接下来我们讲解轻量级锁；</p>
<h3 id="轻量级锁："><a href="#轻量级锁：" class="headerlink" title="轻量级锁："></a><strong>轻量级锁：</strong></h3><ul>
<li>当锁是偏向锁的时候，被另外的线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，从而提高性能。</li>
<li>在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁标志位为“01”状态，是否为偏向锁为“0”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间，用于存储锁对象目前的Mark Word的拷贝，然后拷贝对象头中的Mark Word复制到锁记录中。</li>
<li>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock Record里的owner指针指向对象的Mark Word。</li>
<li>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，表示此对象处于轻量级锁定状态。</li>
<li>如果轻量级锁的更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行，否则说明多个线程竞争锁。</li>
<li>若当前只有一个等待线程，则该线程通过自旋进行等待。但是当自旋超过一定的次数，或者一个线程在持有锁，一个在自旋，又有第三个来访时，轻量级锁升级为重量级锁。</li>
<li>多个线程在不同的时间段请求同一把锁，也就是说没有锁竞争。针对这种情形，Java 虚拟机采用了轻量级锁，来避免重量级锁的阻塞以及唤醒</li>
<li>在没有锁竞争的前提下，减少传统锁使用OS互斥量产生的性能损耗</li>
<li>在竞争激烈时，轻量级锁会多做很多额外操作，导致性能下降</li>
<li>可以认为两个线程交替执行的情况下请求同一把锁</li>
</ul>
<p>分析一个由偏向锁膨胀成轻量级锁的案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample9 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TestDemo testDemo = new TestDemo();</span><br><span class="line">  </span><br><span class="line">        //子线程</span><br><span class="line">        Thread t1 = new Thread()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                synchronized (testDemo)&#123;</span><br><span class="line">                    System.out.println(&quot;t1 lock ing&quot;);</span><br><span class="line">                    System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">         </span><br><span class="line">        t1.join();</span><br><span class="line">  </span><br><span class="line">        //主线程</span><br><span class="line">        synchronized (testDemo)&#123;</span><br><span class="line">            System.out.println(&quot;main lock ing&quot;);</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果（两个线程交替执行的情况下）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">main lock ing</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           e8 48 95 09 (11101000 01001000 10010101 00001001) (160778472)</span><br><span class="line">      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)</span><br><span class="line">      8     4        (object header)                           a0 c1 00 f8 (10100000 11000001 00000000 11111000) (-134168160)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="重量级锁："><a href="#重量级锁：" class="headerlink" title="重量级锁："></a>重量级锁：</h3><ul>
<li><p>多个线程竞争同一个锁的时候，虚拟机会阻塞加锁失败的线程，并且在目标锁被释放的时候，唤醒这些线程；</p>
</li>
<li><p>Java 线程的阻塞以及唤醒，都是依靠操作系统来完成的：os pthread_mutex_lock() ；</p>
</li>
<li><p>升级为重量级锁时，锁标志的状态值变为“10”，此时Mark Word中存储的是指向重量级锁的指针，此时等待锁的线程都会进入阻塞状态</p>
</li>
</ul>
<p>分析一个由轻量级锁膨胀成重量级锁的案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class TestDemo &#123;</span><br><span class="line">&#125;</span><br><span class="line">public class DemoExample9 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TestDemo testDemo = new TestDemo();</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        Thread t1 = new Thread()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                synchronized (testDemo)&#123;</span><br><span class="line">                    System.out.println(&quot;t1 lock ing&quot;);</span><br><span class="line">                    System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">  </span><br><span class="line">        t1.start();</span><br><span class="line">  </span><br><span class="line">        synchronized (testDemo)&#123;</span><br><span class="line">            System.out.println(&quot;main lock ing&quot;);</span><br><span class="line">            System.out.println(ClassLayout.parseInstance(testDemo).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">main lock ing</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           5a ad 00 b0 (01011010 10101101 00000000 10110000) (-1342132902)</span><br><span class="line">      4     4        (object header)                           cf 7f 00 00 (11001111 01111111 00000000 00000000) (32719)</span><br><span class="line">      8     4        (object header)                           a0 c1 00 f8 (10100000 11000001 00000000 11111000) (-134168160)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">t1 lock ing</span><br><span class="line">com.boke.TestDemo object internals:</span><br><span class="line">OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           5a ad 00 b0 (01011010 10101101 00000000 10110000) (-1342132902)</span><br><span class="line">      4     4        (object header)                           cf 7f 00 00 (11001111 01111111 00000000 00000000) (32719)</span><br><span class="line">      8     4        (object header)                           a0 c1 00 f8 (10100000 11000001 00000000 11111000) (-134168160)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br></pre></td></tr></table></figure>

<h3 id="我们再来说一下Java-虚拟机是怎么区分轻量级锁和重量级锁的："><a href="#我们再来说一下Java-虚拟机是怎么区分轻量级锁和重量级锁的：" class="headerlink" title="我们再来说一下Java 虚拟机是怎么区分轻量级锁和重量级锁的："></a>我们再来说一下Java 虚拟机是怎么区分轻量级锁和重量级锁的：</h3><ul>
<li>当进行加锁操作时，Java 虚拟机会判断是否已经是重量级锁。如果不是，它会在当前线程的当前栈桢中划出一块空间，作为该锁的锁记录，并且将锁对象的标记字段复制到该锁记录中。</li>
<li>然后，Java 虚拟机会尝试用 CAS（compare-and-swap）操作替换锁对象的标记字段。这里解释一下，CAS 是一个原子操作，它会比较目标地址的值是否和期望值相等，如果相等，则替换为一个新的值。</li>
<li>假设当前锁对象的标记字段为 X…XYZ，Java 虚拟机会比较该字段是否为 X…X01。如果是，则替换为刚才分配的锁记录的地址。由于内存对齐的缘故，它的最后两位为 00。此时，该线程已成功获得这把锁，可以继续执行了。</li>
<li>如果不是 X…X01，那么有两种可能。第一，该线程重复获取同一把锁。此时，Java 虚拟机会将锁记录清零，以代表该锁被重复获取。第二，其他线程持有该锁。此时，Java 虚拟机会将这把锁膨胀为重量级锁，并且阻塞当前线程。</li>
<li>当进行解锁操作时，如果当前锁记录（你可以将一个线程的所有锁记录想象成一个栈结构，每次加锁压入一条锁记录，解锁弹出一条锁记录，当前锁记录指的便是栈顶的锁记录）的值为 0，则代表重复进入同一把锁，直接返回即可。</li>
<li>否则，Java 虚拟机会尝试用 CAS 操作，比较锁对象的标记字段的值是否为当前锁记录的地址。如果是，则替换为锁记录中的值，也就是锁对象原本的标记字段。此时，该线程已经成</li>
<li>功释放这把锁。</li>
<li>如果不是，则意味着这把锁已经被膨胀为重量级锁。此时，Java 虚拟机会进入重量级锁的释放过程，唤醒因竞争该锁而被阻塞了的线程</li>
</ul>
<hr>
<p>到此为止本篇就讲完了<strong>锁的膨胀过程</strong></p>
<p><img src="/2020/06/28/SynchronizedLock2/06/28/SynchronizedLock2/1.png" alt="1"></p>
<h3 id="总结一下："><a href="#总结一下：" class="headerlink" title="总结一下："></a><strong>总结一下</strong>：</h3><ol>
<li>偏向锁只会在第一次请求时采用 CAS 操作，在锁对象的标记字段中记录下当前线程的地址。在之后的运行过程中，持有该偏向锁的线程的加锁操作将直接返回。它针对的是锁仅会被同一线程持有的情况。</li>
<li>轻量级锁采用 CAS 操作，将锁对象的标记字段替换为一个指针，指向当前线程栈上的一块空间，存储着锁对象原本的标记字段。它针对的是多个线程在不同时间段申请同一把锁的情况。</li>
<li>重量级锁会阻塞、唤醒请求加锁的线程。它针对的是多个线程同时竞争同一把锁的情况。Java 虚拟机采取了自适应自旋，来避免线程在面对非常小的 synchronized 代码块时，仍会被阻塞、唤醒的情况。</li>
</ol>
<p>说完了锁的膨胀过程，<strong>那么会不会有锁的降级呢？</strong></p>
<p>我在hotspot源码中找到了这样的注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// We create a list of in-use monitors for each thread.</span><br><span class="line">//</span><br><span class="line">// deflate_thread_local_monitors() scans a single thread&#x27;s in-use list, while</span><br><span class="line">// deflate_idle_monitors() scans only a global list of in-use monitors which</span><br><span class="line">// is populated only as a thread dies (see omFlush()).</span><br><span class="line">//</span><br><span class="line">// These operations are called at all safepoints, immediately after mutators</span><br><span class="line">// are stopped, but before any objects have moved. Collectively they traverse</span><br><span class="line">// the population of in-use monitors, deflating where possible. The scavenged</span><br><span class="line">// monitors are returned to the monitor free list.</span><br><span class="line">//</span><br><span class="line">// Beware that we scavenge at *every* stop-the-world point. Having a large</span><br><span class="line">// number of monitors in-use could negatively impact performance. We also want</span><br><span class="line">// to minimize the total # of monitors in circulation, as they incur a small</span><br><span class="line">// footprint penalty.</span><br><span class="line">//</span><br><span class="line">// Perversely, the heap size -- and thus the STW safepoint rate --</span><br><span class="line">// typically drives the scavenge rate.  Large heaps can mean infrequent GC,</span><br><span class="line">// which in turn can mean large(r) numbers of objectmonitors in circulation.</span><br><span class="line">// This is an unfortunate aspect of this design.</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F;大概意思是：锁降级确实是会发生的，当 JVM 进入安全点（SafePoint）的时候，会检查是否有闲置的 Monitor，然后试图进行降级</p>
<p>有兴趣的大佬可以在<a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk/jdk/file/896e80158d35/src/hotspot/share/runtime/synchronizer.cpp%E9%93%BE%E6%8E%A5%E4%B8%AD%EF%BC%9A">https://hg.openjdk.java.net/jdk/jdk/file/896e80158d35/src/hotspot/share/runtime/synchronizer.cpp链接中：</a></p>
<p>研究一下deflate_idle_monitors是分析锁降级逻辑的入口，这部分行为还在进行持续改进，因为其逻辑是在安全点内运行，处理不当可能拖长 JVM 停顿（STW，stop-the-world）的时间。</p>

			
      
    </div>
    <div class="article-footer">
	<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/" title="Synchronized锁的膨胀过程（锁的升级过程）深入剖析（三）" target="_blank" rel="external">https://1024chengxuyuan.github.io/2020/06/28/SynchronizedLock2/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://1024chengxuyuan.github.io" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://1024chengxuyuan.github.io" target="_blank"><span class="text-dark">野生程序猿</span><small class="ml-1x">Java Developer</small></a></h3>
        <div>一枚野生程序猿。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="lv-container" data-id="city" data-uid="MTAyMC81MDU0Ny8yNzAzMA==">
        <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
      </div>    
    
  </section>


   
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/06/28/1/" title="如何实现延时任务"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/06/28/SynchronizedLock1/" title="Synchronized底层优化（轻量级锁、偏向锁）（二）"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/1024chengxuyuan" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2023 野生程序猿
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span>本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
<script defer type="text/javascript">
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];

    if (typeof LivereTower === 'function') { return; }

    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;

    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>








</body>
</html>